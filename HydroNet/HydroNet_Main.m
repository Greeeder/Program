function [ ] = HydroNet_Main( )
% Controls data flow


%% MODEL CREATION
% All valves and thermostats are assumed open.

%circuit_file='Cyl&pump.txt';
%circuit_file ='Coolant_basic_nodes - copia.txt';
circuit_file = 'Coolant_basic_nodes.txt';
%circuit_file = 'Circuit_test_1.txt';
%circuit_file = 'Cyl&pump&rad-valves.txt';

[ fluid_type, objects, pipe, valve_fix, valve_var, thermostat, pump_volum, pump_turbo, heat_exch_Tout, ...
    heat_exch_fix, tank, nodes_ind, nodes_id, n_nodes, branches_ind, branches_id, branch_cycle, mesh_branches, ...
    node_branches, n_mesh, n_branch, n_tanks, branch_volume, obj_inlet_pos, obj_outlet_pos, branch_htx_Tout, ...
    branch_htx_fix] = HydroNet_Create( circuit_file );



%% INITIALIZATION

gravity_acc = 9.81; % gravity acceleration [m/s^2] for pump power

% Cell to store volumetric position of the points where temperature changes,
% as a % of the total volume of the branch % temperature between those points is constant
% branch_temp_pos = cell(n_branch, 1);
branch_temp_pos = {[0,10,100]; [0, 100]; [0, 100]; [0,20,100]; [0,30,100]; [0, 100]; [0,10,100]};
%branch_temp_pos = {[0,100]};
%branch_temp_pos = {[0,100]; [0, 100]; [0,100]; [0,100]; [0,100]; [0, 100]; [0, 100]};

% Cell to store temperatures of every volume section in the branch
% branch_temperature = cell(n_branch, 1);
branch_temperature = {[20,20]; 20; 20; [20,20]; [20,20]; 20; [20,20]};
%branch_temperature = {20};
%branch_temperature = {20;20;20;20;20;20;20};

% Output variables related to branches
head_loss = zeros(n_branch, 1);
hydr_resist1 = zeros(n_branch, 1);
hydr_resist2 = zeros(n_branch, 1);
flows = zeros(n_branch, 1);



%% EXECUTIONS
% Some variables must be recalculated only if other change

n_exec = 100;

dt_vec = ones(n_exec, 1) * 0.1;

volum_pump_speed =  {105;110;120;130;140;150;160;170;180;190; 200;210;220;230;240;250;260;270;280; 290;300;314;320;330;340;350;360;380; 419; 419; 419; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419};
turbo_pump_speed ={105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ;105; 105; 105; 105; 250; 250; 250 ; 250 ; 250 ; 300; 300; 419 ; 419 ; 419; 419; 419 ;305; 305;275; 275;419; 419 ; 419 ; 419 ; 419; 419; 419; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419 ;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 300 ;300 ;300 ;300 ;300 ;300 ;300 ;300 ;300 ; 290;280; 270; 250; 220 ; 190 ; 150 ; 120; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419; 419; 419; 419; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419;105; 210; 314; 419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419; 419; 419 ; 419 ; 419 ; 419;419;419;419};

valve_opening = {0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;00;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30;30;30;30;30;30;30;30;30;30;30;0;0;0;0;0;0;0;0;0;0;0;30;100;100;100;100;100;100;100;100;30;100;100;100;100;30;30;30;30;30};

    
thst_sensitivity = ones(n_exec, 1) * 5; % thermostat sensitivity [%]

time=-10;
temperature_after_pump=-999;
temperature_after_engine=-999;
temperature_after_radiator=-999;
pump_power=-11;
flows_aux={};
pump_head=0;

% Execution loop
flag_first_exec = true;
for count_exec = 1 : n_exec
    
    % TIME SPAN
    dt = dt_vec(count_exec);
    
    
    % PUMP SPEED
     %If the speed of any pump changes, flows must be recalculated
    
    flag_pump_speed_change = false;
    if or(any(not((volum_pump_speed{count_exec} == pump_volum.pump_speed(:)))), ...
        any(not((turbo_pump_speed{count_exec} == pump_turbo.pump_speed(:)))))
        flag_pump_speed_change = true;
    end
    
    pump_volum.pump_speed(:) = volum_pump_speed{count_exec};
    pump_turbo.pump_speed(:) = turbo_pump_speed{count_exec};
    
    
    % VALVES
    % If the valve opening varies, vectors for head losses and thus flows must be recalculated.
    % If the valve is closed, flow in its branch is zero.
    
    flag_valve_change = false;
   if any(not((valve_opening{count_exec} == valve_var.opening(:))))
      flag_valve_change = true;
   end
    
    valve_var.opening(:) = valve_opening{count_exec};
    
    
    % THERMOSTATS
    % If the thermostat opening varies because there is a change in the inlet
    % temperature, vectors for head losses and thus flows must be recalculated.
    % Head losses and flows will be recalculated only if the opening variation
    % of any thermostat is larger than the sensitivity of the thermostat[%]
    % If the thermostat is closed, flow in its branch is zero.
    
    thermostat_opening_new = zeros(size(thermostat, 1), 1);
    for count_thst = 1 : size(thermostat, 1);
        obj_aux = thermostat.obj_index(count_thst);
        branch_aux = objects.branch{obj_aux};
        obj_pos = (obj_inlet_pos{obj_aux} + obj_outlet_pos{obj_aux}) / 2;
        thermostat_temp = HydroNet_GetObjTemperature(obj_pos, branch_temp_pos{branch_aux}, branch_temperature{branch_aux});
        thermostat_opening_new(count_thst) = thermostat.T_coef0(count_thst) + thermostat.T_coef1(count_thst) * thermostat_temp ...
            + thermostat.T_coef2(count_thst) * thermostat_temp^2;
    end
    
    flag_thermostat_changes = false;
    if any(abs(thermostat_opening_new - thermostat.opening(:)) ./ thermostat.opening(:) * 100 > thst_sensitivity(count_exec))
        flag_thermostat_changes = true;
    end
    
    thermostat.opening(:) = thermostat_opening_new;
    
    
    % MAIN EXECUTION FUNCTION CALL
    [ flows, branches_ind, branches_id, branch_temp_pos, branch_temperature, branch_htx_fix, branch_htx_Tout, ...
        heat_exch_Tout, heat_exch_fix, obj_inlet_pos, obj_outlet_pos,pump_volum, head_loss, hydr_resist1, hydr_resist2 ] = HydroNet_Executions ( fluid_type, objects, ...
        pipe, valve_fix, valve_var, thermostat, pump_volum, pump_turbo, heat_exch_Tout, heat_exch_fix, tank, ...
        nodes_ind, nodes_id, n_nodes, branches_ind, branches_id, branch_cycle, mesh_branches, node_branches, ...
        n_mesh, n_branch, n_tanks, branch_volume, obj_inlet_pos, obj_outlet_pos, branch_htx_Tout, branch_htx_fix, ...
        branch_temp_pos, branch_temperature, gravity_acc, dt, flag_pump_speed_change, flag_valve_change, ...
        flag_thermostat_changes, flag_first_exec, head_loss, hydr_resist1, hydr_resist2, flows ); 
    
     [temperature_after_pump,temperature_after_engine,temperature_after_radiator,time] ...
=register( branch_temp_pos, branch_temperature,dt,time,flag_first_exec,temperature_after_pump,...
temperature_after_engine,temperature_after_radiator);

if flag_first_exec
     pump_power(1)=pump_volum.pump_power(1);
     flow(1)=flows(1);
      speed(1)=pump_volum.pump_speed(1);
%      flows_aux=flows;
      pump_head(1)=pump_volum.pump_head(1);
else
    pump_power(end+1)=pump_volum.pump_power(1);
    flow(end+1)=flows(1);
    speed(end+1)=pump_volum.pump_speed(1);
%    flows_aux(end+1)=flows;
     pump_head(end+1)=pump_volum.pump_head(1);
end
     
     
    flag_first_exec = false;
    
    display(flows);

    
end

   figure
plot(time,temperature_after_pump,'b')
hold on
plot(time,temperature_after_engine,'r')
hold on
plot(time,temperature_after_radiator,'k')

figure 
bar(flows)

figure
plotyy(time,pump_power,time,flow)
figure
plot(time,speed,'k')
figure
plot(time,pump_head)
%figure
%plotyy(time,flows)
end
